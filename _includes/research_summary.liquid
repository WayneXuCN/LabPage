<div id="research-summary">
  {% assign research_page = site.pages | where: 'layout', 'page' | where: 'permalink', '/research/' | first %}
  {% if research_page %}
    <div class="research-description-plain">
      {{ research_page.content | markdownify }}
    </div>

    {% if research_page.research_questions and research_page.research_questions.size > 0 %}
      <div class="research-tabs {% if research_page.research_questions.size <= 3 %}research-tabs-{{research_page.research_questions.size}}{% else %}research-tabs-multi{% endif %}">
        {% for research in research_page.research_questions %}
          <div
            class="research_tab {% if forloop.first %}active{% endif %}"
            role="tab"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            tabindex="0"
            onclick="toggle_research_vis('research_{{ forloop.index }}', this)"
          >
            <span class="tab-text">{{ research.title }}</span>
            <span class="tab-indicator"></span>
          </div>
        {% endfor %}
      </div>

      <div class="research-contents">
        {% for research in research_page.research_questions %}
          <div
            class="research_summary"
            id="research_{{ forloop.index }}"
            style="display: {% if forloop.first %}block{% else %}none{% endif %};"
            role="tabpanel"
            aria-hidden="{% if forloop.first %}false{% else %}true{% endif %}"
          >
            <img
              class="research_picture"
              src="{{ research.image }}"
              alt="{{ research.title }}"
              loading="lazy"
            >
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>未找到研究问题数据。请在研究页面的front matter中添加至少一个research_questions项目。</p>
    {% endif %}
  {% else %}
    <p>未找到研究页面。请确认存在路径为"/research/"的页面。</p>
  {% endif %}
</div>

<script>
  // 预加载所有研究图片
  window.addEventListener('load', function () {
    const summaries = document.getElementsByClassName('research_summary');
    for (let i = 0; i < summaries.length; i++) {
      const img = summaries[i].querySelector('img');
      if (img && img.src) {
        const preloadImg = new Image();
        preloadImg.src = img.src;
      }
    }
  });

  // 切换状态管理
  let isSwitching = false;
  let switchTimeout = null;

  function toggle_research_vis(target, tabElement) {
    // 如果正在切换中，直接返回
    if (isSwitching) return;
    
    const summaries = document.getElementsByClassName('research_summary');
    const activeElement = document.getElementById(target);
    const container = document.querySelector('.research-contents');
    
    // 查找当前活动内容
    let currentActive = null;
    for (let i = 0; i < summaries.length; i++) {
      if (summaries[i].style.display === 'block') {
        currentActive = summaries[i];
        break;
      }
    }
    
    // 如果点击的是当前已激活的标签，直接返回
    if (currentActive === activeElement) return;
    
    // 标记为正在切换
    isSwitching = true;
    
    // 清除之前的定时器
    if (switchTimeout) {
      clearTimeout(switchTimeout);
      switchTimeout = null;
    }

    // 固定容器高度，避免跳动
    if (container) {
      const currentHeight = container.offsetHeight;
      container.style.height = `${currentHeight}px`;
      container.style.overflow = 'hidden';
      container.style.transition = 'height 0.3s ease';
    }

    // 切换内容
    if (currentActive) {
      // 淡出当前内容
      currentActive.style.opacity = '0';
      currentActive.style.transition = 'opacity 0.3s ease';
      
      switchTimeout = setTimeout(() => {
        // 隐藏当前内容
        currentActive.style.display = 'none';
        currentActive.setAttribute('aria-hidden', 'true');
        
        // 显示新内容
        activeElement.style.display = 'block';
        activeElement.style.opacity = '0';
        activeElement.style.transition = 'opacity 0.3s ease';
        activeElement.setAttribute('aria-hidden', 'false');
        
        // 获取新高度
        const newHeight = activeElement.offsetHeight;
        
        // 更新容器高度
        if (container) {
          container.style.height = `${newHeight}px`;
        }
        
        // 淡入新内容
        requestAnimationFrame(() => {
          activeElement.style.opacity = '1';
        });
        
        switchTimeout = setTimeout(() => {
          // 重置容器样式
          if (container) {
            container.style.height = '';
            container.style.overflow = '';
            container.style.transition = '';
          }
          // 重置切换状态
          isSwitching = false;
          switchTimeout = null;
        }, 350);
      }, 300);
    } else {
      // 没有当前活动元素，直接显示
      activeElement.style.display = 'block';
      activeElement.style.opacity = '1';
      activeElement.setAttribute('aria-hidden', 'false');
      if (container) {
        setTimeout(() => {
          container.style.height = '';
          container.style.overflow = '';
          container.style.transition = '';
        }, 50);
      }
      isSwitching = false;
    }

    // 更新标签状态
    const tabs = document.getElementsByClassName('research_tab');
    for (let i = 0; i < tabs.length; i++) {
      tabs[i].className = 'research_tab';
      tabs[i].setAttribute('aria-selected', 'false');
    }
    tabElement.className = 'research_tab active';
    tabElement.setAttribute('aria-selected', 'true');
  }
</script>

<style>
  .research-description-plain {
    margin-bottom: 28px;
    line-height: 1.6;
  }

  .research-description-plain p {
    margin-bottom: 12px;
  }

  .research-description-plain ul {
    margin-bottom: 12px;
    padding-left: 20px;
  }

  .research-tabs {
    display: flex;
    justify-content: space-between;
    margin-bottom: 25px;
    gap: 15px;
  }

  /* 动态调整按钮宽度根据数量 */
  .research-tabs-1 .research_tab {
    width: 100%;
  }

  .research-tabs-2 .research_tab {
    width: 48%;
  }

  .research_tab {
    position: relative;
    padding: 12px 15px;
    cursor: pointer;
    border-radius: 8px;
    background-color: #f8f8f8;
    color: var(--research-tab-text-color);
    flex: 1;
    text-align: center;
    font-family: inherit;
    font-weight: 500;
    border: 1px solid #e0e0e0;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .research_tab,
  .research_tab * {
    color: #222 !important;
  }

  .research_tab .tab-text {
    position: relative;
    z-index: 2;
    transition: color 0.3s ease;
  }

  .research_tab .tab-indicator {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 2px;
    background-color: #5f6f52;
    transition: width 0.3s ease;
  }

  .research_tab:hover {
    background-color: #f0f0f0;
    transform: translateY(-2px);
  }

  .research_tab:hover .tab-indicator {
    width: 40%;
  }

  /* 标签激活状态样式 */
  .research_tab.active {
    color: var(--research-tab-text-color) !important;
    background-color: #5f6f52;
    border-color: #5f6f52;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(95, 111, 82, 0.25);
  }

  .research_tab.active,
  .research_tab.active *,
  .research_tab.active .tab-text,
  .research_tab.active span {
    color: #fff !important;
  }

  /* 确保激活标签内的所有元素保持一致的颜色方案 */
  .research_tab.active .tab-text,
  .research_tab.active span {
    background-color: transparent !important;
    color: white !important;
  }

  /* 激活标签指示器样式 */
  .research_tab.active .tab-indicator {
    width: 60%;
    background-color: rgba(255, 255, 255, 0.5);
  }

  /* 研究内容摘要容器样式 */
  .research_summary {
    display: none;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    opacity: 1;
    transition: opacity 0.3s ease;
    width: 100%;
  }

  /* 研究内容外层容器样式 - 处理高度动态变化 */
  .research-contents {
    position: relative;
    transition: height 0.3s ease;
    will-change: height;
    /* 提前告知浏览器元素高度将发生变化，优化渲染性能 */
    min-height: 100px;
    /* 设置最小高度避免塌陷 */
  }

  .research_summary img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    transition: transform 0.5s ease;
    display: block;
    will-change: transform;
    /* 优化图片变换性能 */
  }

  .research_summary:hover img {
    transform: scale(1.01);
  }

  /* 确保容器在高度过渡期间不影响页面布局 */
  #research-summary {
    contain: layout;
    /* 隔离内部布局变化 */
  }
</style>
